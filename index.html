<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Cars</title>
	
	<style type="text/css" media="screen">
		.container {			
			width: 300px;
			margin: 0 auto;
		}
		#canvas {
			border: 1px solid #333;
		}
	</style>

</head>
<body>

<div class="container">
	<span id="score">0</span>
	<canvas id="canvas" width="260" height="420">	
</div>

</canvas>

<script type="text/javascript">
	
 	
 	var canvas, ctx, speed = 1, canvasWidth, canvasHeight, status;

 	canvas = document.querySelector('#canvas');
	ctx = canvas.getContext('2d');

	canvasWidth = canvas.width;
	canvasHeight = canvas.height;

	var score = {
		value: 0,
		ele: document.querySelector('#score'),
		update: function() {
			this.value++;
			this.ele.innerHTML = this.value;
		}
	}

	var states = {
		playing: 1,
		paused: 2,
		loser: 3
	}

 	// Background
 	var background = {
 		x: 0,
 		y: 0,
 		width: canvasWidth,
 		height: canvasHeight,
 		draw: function() {
 			//ctx.fillStyle = '#ACC7BB';
 			ctx.fillStyle = '#FFF';
 			ctx.fillRect(this.x, this.y, this.width, this.height);
 		}
 	}

 	// Grids
 	var grids = {
 		x: 0,
 		y: 0,
 		width: 20,
 		height: 20,
 		draw: function() {
 			ctx.strokeStyle = '#CCC';
 			var x,y = 0;
 			for (var i = 0; i < (canvasHeight / this.height); i++) {	
 				x = 0;
	 			for (var j = 0; j < (canvasWidth / this.width); j++) {
	 				ctx.strokeRect(x, y, this.width, this.height);
	 				x += this.width;
	 			} 			 		
 				y += this.height;
 			}	
 		}
 	}

 	// Enemies
 	var enemies = {
 		cars: [],
 		posicoes: [40, 140],
 		x: 40,
 		y: -100,
 		width: 80,
 		height: 100,
 		delayInsert: 0,
 		insert: function() {
 			this.cars.push({
 				x: this.posicoes[Math.floor(Math.random() * 2)],
 				y: this.y
 			});
 			this.delayInsert = Math.round(130 / speed);
 		},
 		draw: function() {
 			for (var i = 0; i < this.cars.length; i++) {
 				this.cars[i].y += speed;
 				ctx.strokeStyle = '#000';
				ctx.strokeRect(this.cars[i].x, this.cars[i].y, this.width, this.height);
			}			
 		},
 		update: function() { 			
 			if (this.delayInsert == 0) {
 				this.insert();
 			} else {
 				this.delayInsert--;
 			}
 			for (var i = 0, tam = this.cars.length; i < tam; i++) {

 				var enemi = this.cars[i];
 				enemi.y += speed;

 				if (enemi.x == car.x && (enemi.y + this.height) >= car.y && enemi.y <= (car.y + car.height)) {

 					console.log('COLIDIU!');
 					status = states.loser;

 				} else if (enemi.y >= canvasHeight) {
 					this.cars.splice(i,1);
 					tam--;
 					i--;
 					score.update();
 				}

			}
 		},
 		clear: function() {
 			this.cars = [];
 		}
 	}

 	// Car
 	var car = {
 		x: 40,
 		y: (canvasHeight-120),
 		width: 80,
 		height: 100,
 		draw: function() {
 			ctx.strokeStyle = '#000';
 			ctx.strokeRect(this.x, this.y, this.width, this.height);
 		}
 	}

 	function keypress(e) {
 		if (status == states.playing) {
 			// Car Right
	 		if (e.keyCode == 39) {
	 			car.x = 140;
	 		} 
	 		// Car Lefts
	 		else if (e.keyCode == 37) {
	 			car.x = 40;
	 		}
 		} 		
 	}

 	function draw() {
 		background.draw();
 		grids.draw();
 		car.draw();
 		if (status == states.playing) {
	 		enemies.draw();	 		
 		}
 	}

 	function update() {
 		if (status == states.playing) {
 			enemies.update();

 			if (score.value > 5 && score.value < 15) {
 				speed = 2;
 			} else if (score.value >= 15 && score.value < 30) {
 				speed = 3;
 			} else if (score.value >= 30) {
 				speed = 4;
 			}

 		} else if (status == states.loser) {
 			enemies.clear();
 		} 		
 	}

 	function run() {
    	update();
		draw();
    	window.requestAnimationFrame(run);
 	}

 	function init() {	

		document.addEventListener('keydown', keypress);
		status = states.playing;

		run();

 	}

 	init(); 	

</script>
	
</body>
</html>